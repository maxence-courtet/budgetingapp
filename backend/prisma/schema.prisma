generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  auth0Id   String   @unique
  email     String
  name      String
  createdAt DateTime @default(now())

  accounts        Account[]
  categories      Category[]
  transactions    Transaction[]
  budgetTemplates BudgetTemplate[]
  budgetDefinitions BudgetTransactionDefinition[]
  months          Month[]
}

model Account {
  id        String   @id @default(uuid())
  name      String
  type      String
  notes     String?
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  transactionsFrom          Transaction[]              @relation("FromAccount")
  transactionsTo            Transaction[]              @relation("ToAccount")
  budgetDefinitionsFrom     BudgetTransactionDefinition[] @relation("BudgetFromAccount")
  budgetDefinitionsTo       BudgetTransactionDefinition[] @relation("BudgetToAccount")

  @@index([userId])
}

model Category {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  transactions      Transaction[]
  budgetDefinitions  BudgetTransactionDefinition[]

  @@unique([name, userId])
  @@index([userId])
}

model Transaction {
  id              String   @id @default(uuid())
  type            String   // INCOME, SPENDING, TRANSFER
  date            DateTime
  amount          Float
  description     String?
  status          String   @default("PLANNED") // PLANNED, PAID, PENDING, SKIPPED

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  // For TRANSFER: the category on the receiving (toAccount) side
  toCategoryId String?

  monthId String
  month   Month @relation(fields: [monthId], references: [id])

  fromAccountId String?
  fromAccount   Account? @relation("FromAccount", fields: [fromAccountId], references: [id])

  toAccountId String?
  toAccount   Account? @relation("ToAccount", fields: [toAccountId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt

  @@index([userId])
}

model BudgetTemplate {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  modifiedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  definitions BudgetTransactionDefinition[]
  months      Month[]

  @@index([userId])
}

model BudgetTransactionDefinition {
  id          String  @id @default(uuid())
  type        String  // INCOME, SPENDING, TRANSFER
  amount      Float
  description String?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  budgetTemplateId String
  budgetTemplate   BudgetTemplate @relation(fields: [budgetTemplateId], references: [id], onDelete: Cascade)

  fromAccountId String?
  fromAccount   Account? @relation("BudgetFromAccount", fields: [fromAccountId], references: [id])

  toAccountId String?
  toAccount   Account? @relation("BudgetToAccount", fields: [toAccountId], references: [id])

  // For transfers: category for the credit side
  toCategoryId String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Month {
  id        String   @id @default(uuid())
  month     Int
  year      Int
  createdAt DateTime @default(now())

  budgetTemplateId String?
  budgetTemplate   BudgetTemplate? @relation(fields: [budgetTemplateId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  transactions Transaction[]

  @@unique([month, year, userId])
  @@index([userId])
}
